name: Deploy to Fly.io (Branch-based)

on:
  pull_request:
    branches: [main]
  push:
    branches-ignore: [main]

jobs:
  deploy:
    name: Deploy branch preview
    runs-on: ubuntu-latest
    environment: preview

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Generate unique app name
        id: app-name
        run: |
          BRANCH_SLUG=$(echo '${{ github.head_ref || github.ref_name }}' | \
            sed 's/[^a-z0-9-]/-/g' | \
            sed 's/github/gh/g' | \
            sed 's/flyio/fly/g')
          TIMESTAMP=$(date +%s | cut -c 6-10)
          HASH=$(echo $BRANCH_SLUG | md5sum | cut -c1-4)
          echo "FLY_APP=deply-test-${BRANCH_SLUG}-${TIMESTAMP}-${HASH}" >> $GITHUB_ENV
          echo "Generated app name: deply-test-${BRANCH_SLUG}-${TIMESTAMP}-${HASH}"

      - name: Deploy to Fly.io
        run: |
          if flyctl apps list | grep -q $FLY_APP; then
            echo "App exists, deploying..."
            flyctl deploy --remote-only --app $FLY_APP
          else
            echo "Creating new app..."
            flyctl launch --name $FLY_APP --region nrt --no-deploy --now
            flyctl deploy --remote-only --app $FLY_APP
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
